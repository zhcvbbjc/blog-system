<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout}">
<head>
    <title th:text="${article.title + ' - æ™ºèƒ½åšå®¢ç³»ç»Ÿ'}">æ–‡ç« è¯¦æƒ… - æ™ºèƒ½åšå®¢ç³»ç»Ÿ</title>
</head>
<body>
    <div th:fragment="content">
        <div class="container">
            <div class="grid grid-2">
                <!-- å·¦ä¾§ï¼šæ–‡ç« å†…å®¹ -->
                <div class="main-content">
                    <article class="card">
                        <header class="article-header">
                            <h1 class="article-title" th:text="${article.title}">æ–‡ç« æ ‡é¢˜</h1>
                            
                            <div class="article-meta">
                                <span>
                                    <a th:href="@{/user/{id}(id=${article.author.id})}" 
                                       th:text="${article.author.username}">ä½œè€…</a>
                                </span>
                                <span th:text="${#temporals.format(article.createdAt, 'yyyy-MM-dd HH:mm')}">å‘å¸ƒæ—¶é—´</span>
                                <span th:text="${article.viewCount} + ' é˜…è¯»'">0 é˜…è¯»</span>
                                <span th:text="${article.likeCount} + ' ç‚¹èµ'">0 ç‚¹èµ</span>
                                <span th:text="${article.commentCount} + ' è¯„è®º'">0 è¯„è®º</span>
                            </div>

                            <div class="article-tags" th:if="${article.tags}">
                                <a th:each="tag : ${article.tags}" 
                                   th:href="@{/tag/{tag}(tag=${tag})}"
                                   class="tag" 
                                   th:text="${tag}">æ ‡ç­¾</a>
                            </div>
                        </header>

                        <div class="article-actions mb-3">
                            <button class="action-btn like-btn" 
                                    th:attr="data-article-id=${article.id}"
                                    onclick="toggleLike([[${article.id}]])">
                                <span>ğŸ‘</span>
                                <span class="count" th:text="${article.likeCount}">0</span>
                            </button>
                            
                            <button class="action-btn" 
                                    onclick="shareArticle('[[${article.title}]]', window.location.href)">
                                <span>åˆ†äº«</span>
                            </button>
                        </div>

                        <div class="article-content" th:utext="${article.content}">
                            <!-- æ–‡ç« å†…å®¹ -->
                        </div>
                    </article>

                    <!-- è¯„è®ºåŒº -->
                    <div class="card mt-3">
                        <h3 class="card-title">è¯„è®º</h3>
                        <div id="commentsList">
                            <!-- è¯„è®ºå°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </div>

                        <!-- è¯„è®ºè¡¨å• -->
                        <div class="comment-form" th:if="${user}">
                            <form id="commentForm" onsubmit="submitComment(event)">
                                <div class="form-group">
                                    <textarea class="form-textarea" 
                                              id="commentContent" 
                                              placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." 
                                              required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">å‘è¡¨è¯„è®º</button>
                            </form>
                        </div>
                        <div th:unless="${user}">
                            <p class="text-center">è¯·<a href="/login">ç™»å½•</a>åå‘è¡¨è¯„è®º</p>
                        </div>
                    </div>

                    <!-- ç›¸å…³æ–‡ç«  -->
                    <div class="card mt-3">
                        <h3 class="card-title">ç›¸å…³æ–‡ç« </h3>
                        <div id="relatedArticles">
                            <!-- ç›¸å…³æ–‡ç« å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šç›®å½•å¯¼èˆª -->
                <div class="sidebar">
                    <div class="sidebar-title">ç›®å½•</div>
                    <div class="table-of-contents" id="toc">
                        <!-- ç›®å½•å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const articleId = [[${article.id}]];
        
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç‚¹èµçŠ¶æ€
            if (localStorage.getItem('token')) {
                checkLikeStatus(articleId);
            }
            
            // åŠ è½½è¯„è®º
            loadComments(articleId);
            
            // ç”Ÿæˆç›®å½•
            generateTOC();
        });

        async function loadComments(articleId) {
            try {
                const comments = await apiRequest(`/comments/article/${articleId}`, {
                    method: 'GET'
                });
                
                const commentsList = document.getElementById('commentsList');
                if (commentsList && comments.length > 0) {
                    commentsList.innerHTML = comments.map(comment => `
                        <div class="comment">
                            <div class="comment-header">
                                <span class="comment-author">${comment.author.username}</span>
                                <span class="comment-time">${formatDate(comment.createdAt)}</span>
                            </div>
                            <div class="comment-content">${comment.content}</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
            }
        }

        async function submitComment(event) {
            event.preventDefault();
            
            const content = document.getElementById('commentContent').value;
            if (!content.trim()) {
                showMessage('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            try {
                await apiRequest(`/comments/article/${articleId}`, {
                    method: 'POST',
                    body: JSON.stringify({ content: content })
                });
                
                showMessage('è¯„è®ºå‘è¡¨æˆåŠŸ', 'success');
                document.getElementById('commentContent').value = '';
                loadComments(articleId);
            } catch (error) {
                showMessage(error.message || 'è¯„è®ºå‘è¡¨å¤±è´¥', 'error');
            }
        }

        function generateTOC() {
            const content = document.querySelector('.article-content');
            if (!content) return;
            
            const headings = content.querySelectorAll('h2, h3');
            const toc = document.getElementById('toc');
            
            if (headings.length === 0 || !toc) return;
            
            const tocList = document.createElement('ul');
            headings.forEach((heading, index) => {
                const id = `heading-${index}`;
                heading.id = id;
                
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#${id}`;
                a.textContent = heading.textContent;
                a.onclick = function(e) {
                    e.preventDefault();
                    heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
                };
                
                li.appendChild(a);
                tocList.appendChild(li);
            });
            
            toc.appendChild(tocList);
        }
    </script>
</body>
</html>

